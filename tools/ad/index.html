
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Active Directory, Velociraptor, SIEM - Hybrid + Identity Cyber Range</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#active-directory-velociraptor-and-siem-lab" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Hybrid + Identity Cyber Range" class="md-header__button md-logo" aria-label="Hybrid + Identity Cyber Range" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Hybrid + Identity Cyber Range
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Active Directory, Velociraptor, SIEM
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/iknowjason/PurpleCloud" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    iknowjason/PurpleCloud
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../overview/" class="md-tabs__link">
      Overview
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../install/" class="md-tabs__link">
      Installation
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../aad/" class="md-tabs__link md-tabs__link--active">
        Tool Usage
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../cost/" class="md-tabs__link">
      Cost
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../references/" class="md-tabs__link">
      References
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../future/" class="md-tabs__link">
      Roadmap Ideas
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../conferences/" class="md-tabs__link">
      Conferences
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../credits/" class="md-tabs__link">
      Credits
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Hybrid + Identity Cyber Range" class="md-nav__button md-logo" aria-label="Hybrid + Identity Cyber Range" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Hybrid + Identity Cyber Range
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/iknowjason/PurpleCloud" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    iknowjason/PurpleCloud
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Tool Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tool Usage" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Tool Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../aad/" class="md-nav__link">
        Azure AD lab
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Active Directory, Velociraptor, SIEM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Active Directory, Velociraptor, SIEM
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#important-note" class="md-nav__link">
    Important Note
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-examples" class="md-nav__link">
    Usage Examples
  </a>
  
    <nav class="md-nav" aria-label="Usage Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-one-windows-10-endpoint-with-sysmon-installed" class="md-nav__link">
    Example 1: One Windows 10 Endpoint with Sysmon installed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-domain-controller-with-forest-and-users-windows-domain-join-randomly-generate-users" class="md-nav__link">
    Example 2: Domain Controller with Forest and Users + Windows Domain Join (Randomly Generate Users)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-domain-controller-with-forest-and-users-windows-domain-join-import-custom-users-from-csv" class="md-nav__link">
    Example 3: Domain Controller with Forest and Users + Windows Domain Join (Import Custom Users from CSV)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-4-build-a-veloicraptor-hunting-elk-server-and-automatically-export-sysmon-winlog-beat-logs" class="md-nav__link">
    Example 4: Build a Veloicraptor + Hunting ELK server and automatically export sysmon winlog beat logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#details" class="md-nav__link">
    Details
  </a>
  
    <nav class="md-nav" aria-label="Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#advanced-command-line" class="md-nav__link">
    Advanced Command Line
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-ad-builds-on-the-dc" class="md-nav__link">
    How AD Builds on the DC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edit-script-options-in-adpy" class="md-nav__link">
    Edit script options in ad.py
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform-outputs" class="md-nav__link">
    Terraform Outputs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    Demo
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sentinel/" class="md-nav__link">
        Sentinel lab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../storage/" class="md-nav__link">
        Storage lab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../midentity/" class="md-nav__link">
        Managed Identity lab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../phishing_app/" class="md-nav__link">
        Phishing App
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../adfs/" class="md-nav__link">
        ADFS lab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../aadjoin/" class="md-nav__link">
        AAD Join
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../cost/" class="md-nav__link">
        Cost
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../future/" class="md-nav__link">
        Roadmap Ideas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../conferences/" class="md-nav__link">
        Conferences
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../credits/" class="md-nav__link">
        Credits
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#important-note" class="md-nav__link">
    Important Note
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-examples" class="md-nav__link">
    Usage Examples
  </a>
  
    <nav class="md-nav" aria-label="Usage Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-one-windows-10-endpoint-with-sysmon-installed" class="md-nav__link">
    Example 1: One Windows 10 Endpoint with Sysmon installed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-domain-controller-with-forest-and-users-windows-domain-join-randomly-generate-users" class="md-nav__link">
    Example 2: Domain Controller with Forest and Users + Windows Domain Join (Randomly Generate Users)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-domain-controller-with-forest-and-users-windows-domain-join-import-custom-users-from-csv" class="md-nav__link">
    Example 3: Domain Controller with Forest and Users + Windows Domain Join (Import Custom Users from CSV)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-4-build-a-veloicraptor-hunting-elk-server-and-automatically-export-sysmon-winlog-beat-logs" class="md-nav__link">
    Example 4: Build a Veloicraptor + Hunting ELK server and automatically export sysmon winlog beat logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#details" class="md-nav__link">
    Details
  </a>
  
    <nav class="md-nav" aria-label="Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#advanced-command-line" class="md-nav__link">
    Advanced Command Line
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-ad-builds-on-the-dc" class="md-nav__link">
    How AD Builds on the DC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edit-script-options-in-adpy" class="md-nav__link">
    Edit script options in ad.py
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terraform-outputs" class="md-nav__link">
    Terraform Outputs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    Demo
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/iknowjason/PurpleCloud/edit/master/docs/tools/ad.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="active-directory-velociraptor-and-siem-lab">Active Directory, Velociraptor, and SIEM Lab</h1>
<h2 id="overview">Overview</h2>
<p>Generating an Azure infrastructure lab using ad.py.  This generator can create standalone Windows 10 endpoints, a full domain-joined enterprise Active Directory environment with users, or a SIEM with Velociraptor. </p>
<h3 id="important-note">Important Note</h3>
<p>This generator lives in the <code>generators/ad</code> directory.  Navigate into this directory first.</p>
<pre><code>cd generators/ad
</code></pre>
<h2 id="usage-examples">Usage Examples</h2>
<h3 id="example-1-one-windows-10-endpoint-with-sysmon-installed">Example 1: One Windows 10 Endpoint with Sysmon installed</h3>
<pre><code>python3 ad.py --endpoint 1
</code></pre>
<p><strong>Description:</strong>
This will generate a single Windows 10 Endpoint and generate a random, unique password with a default local Administrator account named <code>RTCAdmin</code>.  This generates the following terraform files:</p>
<ul>
<li>
<p><strong>main.tf:</strong> Terraform file with resource group and location.</p>
</li>
<li>
<p><strong>network.tf:</strong> Terraform file with VNet and subnets. </p>
</li>
<li>
<p><strong>nsg.tf:</strong> Terraform file with Network Security Groups.</p>
</li>
<li>
<p><strong>providers.tf:</strong> Terraform file containing terraform providers.</p>
</li>
<li>
<p><strong>sysmon.tf:</strong> Terraform file containing sysmon configuration.</p>
</li>
<li>
<p><strong>win10-1.tf:</strong> Terraform file with Windows 10 Pro configuration.</p>
</li>
</ul>
<h3 id="example-2-domain-controller-with-forest-and-users-windows-domain-join-randomly-generate-users">Example 2: Domain Controller with Forest and Users + Windows Domain Join (Randomly Generate Users)</h3>
<pre><code>python3 ad.py --domain_controller --ad_domain rtcfingroup.com --admin RTCAdmin --password MyPassword012345 --ad_users 500 --endpoints 2  --domain_join
</code></pre>
<p><strong>Description:</strong>
This will create a Domain Controller in <code>dc.tf</code> and install AD DS with forest name of <code>rtcfingroup.com</code>.  This will create a custom local administrator account and password with 500 domain users.  In this example, the domain users are randomly generated using the command line flag of <code>--ad_users</code> for a total of 500 users.  The domain users will be written to ad_users.csv and will have the password specified in --password.  Note that domain join is disabled by default for Windows 10 Pro but the <code>domain_join</code> parameter enables it for all Windows 10 Pro created.  This will also create two Windows 10 Pro terraform files (win10-1.tf, win10-2.tf) as well as a terraform file for the Domain Controller (dc.tf).</p>
<h3 id="example-3-domain-controller-with-forest-and-users-windows-domain-join-import-custom-users-from-csv">Example 3: Domain Controller with Forest and Users + Windows Domain Join (Import Custom Users from CSV)</h3>
<pre><code>python3 ad.py --domain_controller --ad_domain rtcfingroup.com --admin RTCAdmin --password MyPassword012345 --csv users.csv --endpoints 2  --domain_join
</code></pre>
<p><strong>Description:</strong>
Same capabilities as above, except it can import a custom list of Domain Users into active directory on the DC instance.  The script checks to make sure that users are in the correct format.  An example CSV showing five users is listed below:</p>
<pre><code>name,upn,password,groups,oupath,domain_admin
Lars Borgerson,larsborgerson@rtcfingroup.com,MyPassword012345,IT,OU=IT;DC=rtcfingroup;DC=com,False
Olivia Odinsdottir,oliviaodinsdottir@rtcfingroup.com,MyPassword012345,IT,OU=IT;DC=rtcfingroup;DC=com,True
Liem Anderson,liemanderson@rtcfingroup.com,MyPassword012345,IT,OU=IT;DC=rtcfingroup;DC=com,False
John Nilsson,johnnilsson@rtcfingroup.com,MyPassword012345,IT,OU=IT;DC=rtcfingroup;DC=com,False
Jason Lindqvist,jasonlindqvist@rtcfingroup.com,MyPassword012345,IT,OU=IT;DC=rtcfingroup;DC=com,True
</code></pre>
<h3 id="example-4-build-a-veloicraptor-hunting-elk-server-and-automatically-export-sysmon-winlog-beat-logs">Example 4: Build a Veloicraptor + Hunting ELK server and automatically export sysmon winlog beat logs</h3>
<pre><code>python3 ad.py --helk --endpoint 1
</code></pre>
<p><strong>Description:</strong>
This will add a Velociraptor + Hunting ELK server with one Windows 10 Endpoint.  The winlogbeat agent will be installed on Windows 10 Pro and the logs will be sent to the HELK server.  Velociraptor will be installed on the HELK server and the Velociraptor agent on Windows 10 Pro.  The endpoint will automatically register to the Velociraptor server running on HELK.  This will create a terraform file for the HELK server (helk.tf)</p>
<p><strong>Default OS and Application Credentials:</strong></p>
<ul>
<li>
<p><strong>OS username:</strong> helk.</p>
</li>
<li>
<p><strong>HELK Username:</strong> admin.  Can be changed in <code>local.vadmin_username</code>. </p>
</li>
<li>
<p><strong>HELK Password:</strong> Randomly generated.  Can be changed in <code>local.vadmin_password</code>. </p>
</li>
<li>
<p><strong>Velociraptor Username:</strong> admin.  Can be changed in <code>local.vadmin_username</code>. </p>
</li>
<li>
<p><strong>Velociraptor Password:</strong> Randomly generated.  Can be changed in <code>local.vadmin_password</code>. </p>
</li>
</ul>
<p><strong>Accessing Credentials and Application URLs:</strong></p>
<p>After the range has built, type <code>terraform output</code> to get the credentials and URLs for HELK and Velociraptor.</p>
<p><strong>Input Files for Velociraptor + HELK:</strong></p>
<p>The following files are automatically uploaded to storage container and then downloaded by the HELk + Velociraptor system.  They can be fully customized to suit your needs.</p>
<p><strong>Files found in <code>shared</code> directory</strong></p>
<ul>
<li>
<p><strong>Sysmon.zip:</strong> The sysmon version to be used on Windows 10 endpoints.  This version is v14.0.  This file is in the shared directory from the default project directory:  <code>shared/Sysmon.zip</code>. </p>
</li>
<li>
<p><strong>velociraptor-v0.6.5-2-linux-amd64.gz:</strong> The velociraptor linux binary that runs on the server. </p>
</li>
<li>
<p><strong>velociraptor-v0.6.5-2-windows-amd64.msi:</strong>  The velociraptor msi that runs on windows 10 endpoints.</p>
</li>
<li>
<p><strong>winlogbeat-7.9.2-windows-x86_64.zip:</strong> The winlogbeat agent that runs on windows 10 endpoints and ships logs to the HELK server. </p>
</li>
</ul>
<p><strong>Files found in  <code>files/velocihelk</code> directory</strong></p>
<ul>
<li>
<p><strong>sysmonconfig-export.xml:</strong> The sysmon configuration to be used.  Currently uses github.com/SwiftOnSecurity. </p>
</li>
<li>
<p><strong>helk.sh.tpl:</strong> The script used to help build the Hunting ELK (HELK) server. </p>
</li>
<li>
<p><strong>winlogbeat.yml.tpl:</strong> The configuration file for winlogbeat agent that currently sends to HELK using kafka transport.</p>
</li>
<li>
<p><strong>config.yaml.tpl:</strong> The velociraptor configuration file used to build the internal PKI.  This is used on the server and client agents. </p>
</li>
</ul>
<h2 id="details">Details</h2>
<p>There are a few important files that are used in the range that are automatically uploaded and downloaded to resources.  They can be easily customized.</p>
<ul>
<li>
<p><strong>Sysmon.zip:</strong>  This range includes Sysmon version 14.  It lives in <code>shared/Sysmon.zip</code>.  This file gets pushed to a storage container where all Windows 10 endpoints download it.  You can replace it for customizations.</p>
</li>
<li>
<p><strong>AzureADConnect.msi:</strong>  This range includes version 2.x of AzureADConnect MSI installer.  It lives in <code>shared/AzureADConnect.msi</code>.  This file gets pushed to a storage container where the DC downloads it to the local Administrator desktop.  You can replace it for customizations.</p>
</li>
<li>
<p><strong>sysmonconfig-export.xml:</strong>  The sysmon configuration file gets uploaded to a storage container and downloaded by all Windows 10 endpoints.  It lives in <code>files/sysmon/sysmonconfig-export.xml</code>.</p>
</li>
</ul>
<h3 id="advanced-command-line">Advanced Command Line</h3>
<p><code>--resource_group &lt;rg_name&gt;</code>:  Name of the Azure resource group to automatically create  (Default:  PurpleCloud)</p>
<p><code>--location &lt;location&gt;</code>:  The Azure location to use (Default:  eastus)</p>
<p><code>--endpoints &lt;num_of_endpoints&gt;</code>:  Number of Windows 10 Professional systems to build (Default: 0)</p>
<p><code>--helk</code>:  Create a hunting ELK server (with Velociraptor installed) (Default:  Disabled)</p>
<p><code>--domain_controller</code>:  Create a Domain Controller and install AD DS with Forest (Default:  Disabled)</p>
<p><code>--ad_domain &lt;domain&gt;</code>:  The name of the AD Domain to provision (Default:  rtc.local)</p>
<p><code>--ad_users &lt;num_of_domain_users&gt;</code>:  The number of AD users to automatically build (Default:  Disabled)</p>
<p><code>--csv &lt;csv_file&gt;</code>:  A custom CSV file to use that will load domain users on the DC's AD DS  (Default:  Disabled)</p>
<p><code>--admin &lt;admin_username&gt;</code>:  The Local Administrator account (Default:  RTCAdmin)</p>
<p><code>--password &lt;password&gt;</code>:  The local Administrator password and default AD user password (Default:  auto generate a strong password) </p>
<p><code>--domain_join</code>:  Join the Windows 10 Pro systems to the AD Domain (Default:  false)</p>
<p><code>--auto_logon</code>:  Automatically logon the domain user with their credentials upon system start (Default:  false)</p>
<h3 id="how-ad-builds-on-the-dc">How AD Builds on the DC</h3>
<p>Some notes I've gathered on AD usage and building.</p>
<ul>
<li>
<p>Azure AD Connect:  The Azure AD connect MSI is included in ths repo.  It can be upgraded by replacing the file in <code>shared/AzureADConnect.msi</code>.  The current version is 2.x of AD Connect.  The file is uploaded to the storage container and then downloaded to the local Administrator's desktop. </p>
</li>
<li>
<p>The bootstrap script for building Active Directory is contained in <code>files/dc/bootstrap-dc.ps1.tpl</code>.  This script is used to build AD DS on the dc instance created in dc.tf. </p>
</li>
<li>
<p>After terraform runs, the actual rendered dc bootstrap script (with variables) is output to <code>output/dc/bootstrap-dc1.ps1.</code>  For troubleshooting you can copy that script to the DC and run it.</p>
</li>
<li>
<p>The way AD users, groups, and OUs are added:  In the CSV file, there is a field for <code>oupath</code>.  The string for the <code>OU=</code> is looked at and a new OU is created if it hasn't already.  This is the way new OUs can be added.  AD users are added to that specific OU when they are created.  For adding AD Groups, the CSV field for <code>groups</code> is examined.  The user is added into that AD group.  The <code>groups</code> and <code>OU=</code> portion of the oupath should match.  If they don't, problems could arise adding the user.    </p>
</li>
<li>
<p>The <code>ad_users.csv</code> file is the name of the file that the DC uses to build AD.  It is uploaded to the storage container that is created and downloaded automatically by the DC.  Look in <code>C:\terraform\ad_users.csv</code> to look at this file if needed.</p>
</li>
<li>
<p>When using the <code>--csv &lt;file1&gt;</code> to specify your own AD users CSV, how this works:  That file is copied to <code>ad_users.csv</code> and it is uploaded to the storage container, and downloaded to the DC.  Same as above, it is copied into C:\terraform\ad_users.csv where the bootstrap script parses it. </p>
</li>
<li>
<p>For auto_logon domain users:  An AD domain user is randomly selected for logging on that Windows 10 Pro endpoint.  To customize which domain user is used, you can manually edit the windows 10 terraform file (i.e., win10-1.tf).</p>
</li>
</ul>
<h3 id="edit-script-options-in-adpy">Edit script options in ad.py</h3>
<p><strong>Windows 10 Pro configuration:</strong>   The Windows 10 Pro default configuration can be adjusted to meet your needs.</p>
<p>These are located in the <code>config_win10_endpoints</code> dictionary:</p>
<p><code>hostname_base:</code>  The base Windows 10 hostname (Default: win10)</p>
<p><code>join_domain:</code>  Whether to join the Windows 10 Pro to the AD Domain.  This is disabled by default.  So if you add a DC and want to join the Windows 10 Pro systems to the AD Domain, you can set this to true.  Or you can use the command line parameter <code>--domain-join</code>.</p>
<p><code>auto_logon_domain_users:</code>  Configure the endpoint (via registry) to automatically log in the domain user.  This will randomly select an AD user.  Disabled by default and requires domain join and DC.</p>
<p><code>install_sysmon:</code>  Automatically install Sysmon with Swift on Security configuration (Default:  Enabled)</p>
<p><code>install_art:</code>  Install Atomic Red Team (art).  (Default:  Enabled) </p>
<pre><code>config_win10_endpoint = {
    &quot;hostname_base&quot;:&quot;win10&quot;,
    &quot;join_domain&quot;:&quot;false&quot;,
    &quot;auto_logon_domain_user&quot;:&quot;false&quot;,
    &quot;install_sysmon&quot;:sysmon_endpoint_config,
    &quot;install_art&quot;:&quot;true&quot;,
}
</code></pre>
<p><strong>Default AD Users:</strong>   There is a python dictionary specifying the default AD users.  This can be changed to suit your needs.  These are the first five users automaticaly created.  After the first five, users are randomly generated to meet the <code>--ad_users &lt;number&gt;</code> amount.</p>
<p>Here is the default_ad_users list along with the first user, that can be searched for in the file:</p>
<pre><code>default_ad_users = [
    {
        &quot;name&quot;:&quot;Lars Borgerson&quot;,
        &quot;ou&quot;: &quot;CN=users,DC=rtc,DC=local&quot;,
        &quot;password&quot;: get_password(),
        &quot;domain_admin&quot;:&quot;&quot;,
        &quot;groups&quot;:&quot;IT&quot;
    },
</code></pre>
<p><strong>Network Subnets configuration:</strong>   The configuration for the subnets can be adjusted in the python list named <code>config_subnets</code>.  Some changes include changing the default subnet names or adding/removing subnets.  By default there are four subnets created.  </p>
<p><strong>Other Details:</strong>  </p>
<ul>
<li>
<p><strong>ranges.log:</strong>  The ranges.log file writes out important information as the range is built, such as VM details.  You can use it to track things.</p>
</li>
<li>
<p><strong>Logging Passwords:</strong> By default, all passwords are randomly generated.  So if you are not aware of this, it might be easy to lose track of a password.  For this reason we have added a logging feature that captures all passwords created.  The <code>ad.py</code> script will automatically log all output to a logfile called <code>ranges.log</code>.  This is for the specific purpose of being able to track the ranges created and the passwords that are auto-generated for AD users and local Administrator accounts. You can also type <code>terraform output</code> as a secondary way to get the password and details for each virtual machine.</p>
</li>
<li>
<p><strong>Azure Network Security Groups:</strong>  By default, the <code>ad.py</code> script will try to auto-detect your public IP address using a request to http://ifconfig.me.  Your public IP address will be used to white list the Azure NSG source prefix setting.  A second terraform resource is then used to manage and update any changes to your public IP address.  You can hard code a different IP address in the following section of the ad.py script or the terraform nsg.tf file.  If you change locations and your IP address changes, simply type <code>terraform apply</code> and the NSG white-listed public IP address should update through terraform.</p>
</li>
</ul>
<pre><code>locals {
  src_ip = chomp(data.http.firewall_allowed.response_body)
  #src_ip = &quot;0.0.0.0/0&quot;
}
</code></pre>
<ul>
<li><strong>Outputs:</strong> After the terraform resources are applied and build, you can type <code>terraform output</code> to get some important information such as the public IP address of VMs in addition to credentials for OS and applications. </li>
</ul>
<h3 id="terraform-outputs">Terraform Outputs</h3>
<p>You can get the details of each Virtual Machine, including passwords, by typing <code>terraform output</code>.</p>
<h2 id="demo">Demo</h2>
<p>A video demonstration of AD with options and illustrations.</p>
<p><a href="https://youtu.be/dHfdDeqViFg" title="AD Demo"><img alt="AD Demo" src="" /></a></p>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../aad/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Azure AD lab" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Azure AD lab
            </div>
          </div>
        </a>
      
      
        
        <a href="../sentinel/" class="md-footer__link md-footer__link--next" aria-label="Next: Sentinel lab" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Sentinel lab
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.indexes", "navigation.top", "navigation.tabs"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>