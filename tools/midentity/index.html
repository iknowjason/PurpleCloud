
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Managed Identity lab - Hybrid + Identity Cyber Range</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#azure-managed-identity-lab" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Hybrid + Identity Cyber Range" class="md-header__button md-logo" aria-label="Hybrid + Identity Cyber Range" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Hybrid + Identity Cyber Range
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Managed Identity lab
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/iknowjason/PurpleCloud" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    iknowjason/PurpleCloud
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../overview/" class="md-tabs__link">
      Overview
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../install/" class="md-tabs__link">
      Installation
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../aad/" class="md-tabs__link md-tabs__link--active">
        Tool Usage
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../cost/" class="md-tabs__link">
      Cost
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../references/" class="md-tabs__link">
      References
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../future/" class="md-tabs__link">
      Roadmap Ideas
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../conferences/" class="md-tabs__link">
      Conferences
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../credits/" class="md-tabs__link">
      Credits
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Hybrid + Identity Cyber Range" class="md-nav__button md-logo" aria-label="Hybrid + Identity Cyber Range" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Hybrid + Identity Cyber Range
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/iknowjason/PurpleCloud" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    iknowjason/PurpleCloud
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Tool Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tool Usage" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Tool Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../aad/" class="md-nav__link">
        Azure AD lab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ad/" class="md-nav__link">
        Active Directory, Velociraptor, SIEM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sentinel/" class="md-nav__link">
        Sentinel lab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../storage/" class="md-nav__link">
        Storage lab
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Managed Identity lab
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Managed Identity lab
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#important-note" class="md-nav__link">
    Important Note
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-examples" class="md-nav__link">
    Usage Examples
  </a>
  
    <nav class="md-nav" aria-label="Usage Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-windows-10-endpoint-with-a-user-assigned-identity-reader-role" class="md-nav__link">
    Example 1:  Windows 10 Endpoint with a User Assigned Identity (Reader Role)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-windows-10-endpoint-with-a-user-assigned-identity-contributor-role" class="md-nav__link">
    Example 2:  Windows 10 Endpoint with a User Assigned Identity (Contributor Role)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-windows-10-endpoint-with-a-user-assigned-identity-owner-role-system-assigned-identity" class="md-nav__link">
    Example 3: Windows 10 Endpoint with a User Assigned Identity (Owner Role) + System Assigned Identity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#details" class="md-nav__link">
    Details
  </a>
  
    <nav class="md-nav" aria-label="Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#all-resources-created" class="md-nav__link">
    All Resources Created
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#all-options-available" class="md-nav__link">
    All Options Available
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-variables-in-script" class="md-nav__link">
    Other Variables in Script
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    Demo
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../phishing_app/" class="md-nav__link">
        Phishing App
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../adfs/" class="md-nav__link">
        ADFS lab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../aadjoin/" class="md-nav__link">
        AAD Join
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../cost/" class="md-nav__link">
        Cost
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../future/" class="md-nav__link">
        Roadmap Ideas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../conferences/" class="md-nav__link">
        Conferences
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../credits/" class="md-nav__link">
        Credits
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#important-note" class="md-nav__link">
    Important Note
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-examples" class="md-nav__link">
    Usage Examples
  </a>
  
    <nav class="md-nav" aria-label="Usage Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-windows-10-endpoint-with-a-user-assigned-identity-reader-role" class="md-nav__link">
    Example 1:  Windows 10 Endpoint with a User Assigned Identity (Reader Role)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-windows-10-endpoint-with-a-user-assigned-identity-contributor-role" class="md-nav__link">
    Example 2:  Windows 10 Endpoint with a User Assigned Identity (Contributor Role)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-windows-10-endpoint-with-a-user-assigned-identity-owner-role-system-assigned-identity" class="md-nav__link">
    Example 3: Windows 10 Endpoint with a User Assigned Identity (Owner Role) + System Assigned Identity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#details" class="md-nav__link">
    Details
  </a>
  
    <nav class="md-nav" aria-label="Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#all-resources-created" class="md-nav__link">
    All Resources Created
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#all-options-available" class="md-nav__link">
    All Options Available
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-variables-in-script" class="md-nav__link">
    Other Variables in Script
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    Demo
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/iknowjason/PurpleCloud/edit/master/docs/tools/midentity.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="azure-managed-identity-lab">Azure Managed Identity lab</h1>
<h2 id="overview">Overview</h2>
<p>Create an attack and defense lab for managed identity with one Azure Virtual Machine.  An Azure VM is configured with a user assigned managed identity and optional system assigned identity.  An Azure AD user is also created.  Generates terraform format HCL files for <code>managed_identity.tf</code>,  <code>providers.tf</code>, and <code>mi_user.tf</code>.</p>
<h3 id="important-note">Important Note</h3>
<p>This generator lives in the <code>generators/managed_identity</code> directory.  Navigate into this directory first.</p>
<pre><code>cd generators/managed_identity
</code></pre>
<h2 id="usage-examples">Usage Examples</h2>
<h3 id="example-1-windows-10-endpoint-with-a-user-assigned-identity-reader-role">Example 1:  Windows 10 Endpoint with a User Assigned Identity (Reader Role)</h3>
<pre><code>python3 managed_identity.py -u rtcfingroup.com -ua reader
</code></pre>
<p><strong>Description:</strong></p>
<p>This will generate terraform HCL files for a managed identity attack and defense lab.  The following options are enabled:</p>
<p><code>-u rtcfingroup.com:</code> Specify a UPN suffix or default domain for the one Azure AD user that is created.</p>
<p><code>-ua reader:</code> Create a user assigned identity with a Reader role on the subscription, and attach it to the created Azure VM.  </p>
<p><strong>Default Options:</strong></p>
<p><code>Default Administrator:</code> A default local Administrator account on the VM is <code>MIAdmin</code>.</p>
<p><code>Default Password:</code> A default local Administrator password is automatically generated and used for the VM and Azure AD user.</p>
<p><code>Default Name:</code> A default name for resources and resource group is automatically generated by terraform.</p>
<p><code>Default Azure User:</code> An Azure AD user is randomly generated with the upn suffix domain specified above. A role of <code>Virtual Machine Contributor</code> is assigned to the  user by default.</p>
<h3 id="example-2-windows-10-endpoint-with-a-user-assigned-identity-contributor-role">Example 2:  Windows 10 Endpoint with a User Assigned Identity (Contributor Role)</h3>
<pre><code>python3 managed_identity.py -u rtcfingroup.com -ua contributor
</code></pre>
<p><strong>Description:</strong></p>
<p>Same scenario as above except it will set the Contributor role (scoped to Subscription) to the user assigned identity attached to the Azure VM.</p>
<h3 id="example-3-windows-10-endpoint-with-a-user-assigned-identity-owner-role-system-assigned-identity">Example 3: Windows 10 Endpoint with a User Assigned Identity (Owner Role) + System Assigned Identity</h3>
<pre><code>python3 managed_identity.py -u rtcfingroup.com -n rtcfin -l eastus -a RTCAdmin -p MyPassword012345 -ua owner -sa
</code></pre>
<p><strong>Description:</strong></p>
<p>Same scenario as above except it will set the Owner role to the user assigned identity attached to the Azure VM.  Extra options enabled include:</p>
<p><code>-n rtcfin:</code> Specify a friendly name of <code>rtcfin</code> for the Resource Group and some of the Azure resources created.</p>
<p><code>-l eastus:</code> Specify an Azure location of <code>eastus</code> for the Azure resources.</p>
<p><code>-a RTCAdmin:</code> Specify the local Administrator username of <code>RTCAdmin</code> on the Azure VM.</p>
<p><code>-p MyPassword012345:</code> Specify a password for the VM local admin  as well as the Azure AD user.</p>
<p><code>-sa:</code> Enable a System Assigned identity for the Azure VM.</p>
<h2 id="details">Details</h2>
<h3 id="all-resources-created">All Resources Created</h3>
<ul>
<li>One Azure AD User with a configurable Role Assignment (Default:  Virtual Machine Contributor)</li>
<li>One Azure VM with a Managed Identity configured (Default:  User Assigned Identity with Reader on the Subscription)</li>
<li>Azure Storage Account (1)</li>
<li>Azure Containers (3)
The containers have three different access levels (Blob, Container, Private)</li>
<li>Azure Blobs (3).  All three are uploaded to all three containers.</li>
<li>Azure Shares (2)</li>
<li>Two files are uploaded to the two shares</li>
<li>Azure Key Vault</li>
<li>Secrets (3)</li>
<li>Private Keys (1)</li>
<li>Certificates (1)</li>
</ul>
<h3 id="all-options-available">All Options Available</h3>
<p><code>-u &lt;UPN_SUFFIX&gt;</code>:  Mandatory.  Specify the correct UPN Suffix for your tenant.  Needed for creating the Azure AD user.</p>
<p><code>-a &lt;ADMIN_USERNAME&gt;</code>:  Specify the local Administrator Username for the Windows 10 Pro Azure VM. (Default:  MIAdmin)</p>
<p><code>-p &lt;PASSWORD&gt;</code>: Specify the password for the local Administrator account on the VM as well as the Azure AD user (Default:  Auto-generated)</p>
<p><code>-sa</code>: Enables the System Assigned Identity for the Azure VM (Note:  both user assigned and system assigned can be enabled)</p>
<p><code>-ua reader|contributor|owner</code>: Enables the User Assigned Identity for the Azure VM with possible values of reader, contributor, owner (Default:  reader)</p>
<p><code>-n &lt;NAME&gt;</code>:  Specify a resource group name and name for other resources</p>
<p><code>-l &lt;LOCATION&gt;</code>:  Specify a different location (Default: centralus)</p>
<h3 id="other-variables-in-script">Other Variables in Script</h3>
<p>This is the configuration for protecting access to the Azure VM.  By default it will get your public IP address of the workstation running terraform.  You can comment out as appropriate to allow all IP addresses or a specific IP address as shown below.</p>
<pre><code># This is the src_ip for white listing Azure NSGs
locals {
  src_ip = chomp(data.http.firewall_allowed.response_body)
  #src_ip = &quot;0.0.0.0/0&quot;
}
</code></pre>
<p>The role of the user assigned managed identity by default is scoped to the subscription but can be customized as shown below:</p>
<pre><code># Assign the reader role on the Key vault to the Managed Identity
resource &quot;azurerm_role_assignment&quot; &quot;uai&quot; {
  #Scope to the key vault in line below
  #scope                = azurerm_key_vault.example.id
  #Scope to the subscription in line below
  scope                = data.azurerm_subscription.mi.id
  role_definition_name = &quot;ROLE_DEFINITION_NAME&quot;
  principal_id         = azurerm_user_assigned_identity.uai.principal_id
}
</code></pre>
<p>The role of the Azure AD user</p>
<pre><code># The role scoped to subscription for AAD user
# uncomment as needed
variable &quot;user_role&quot; {
  default = &quot;Virtual Machine Contributor&quot;
  #default = &quot;Contributor&quot;
  #default = &quot;Reader&quot;
  #default = &quot;Owner&quot;
}
</code></pre>
<h2 id="demo">Demo</h2>
<p>A video demonstration of building a managed identity lab with options and illustrations.</p>
<p><a href="https://youtu.be/yXuGSi0NhLg" title="Managed Identity Demo"><img alt="Managed Identity Demo" src="" /></a></p>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../storage/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Storage lab" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Storage lab
            </div>
          </div>
        </a>
      
      
        
        <a href="../phishing_app/" class="md-footer__link md-footer__link--next" aria-label="Next: Phishing App" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Phishing App
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.indexes", "navigation.top", "navigation.tabs"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>